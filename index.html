<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>极简编辑器</title><style>*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}body{margin:0;height:100vh;display:flex;flex-direction:column;background:#fff;color:#000;overflow:hidden}header{padding:15px 20px;display:flex;flex-direction:column;gap:10px;border-bottom:1px solid #000}#hd-top{display:flex;justify-content:space-between;align-items:center}h1{margin:0;font-size:18px;font-weight:900;text-transform:uppercase}#hd-btns{display:flex;gap:8px}.btn-s{padding:5px 10px;font-size:11px}#list-view{flex:1;overflow-y:auto;padding:0 20px;-webkit-overflow-scrolling:touch}.item{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid #eee}.item-name{font-size:16px;font-weight:400;color:#000;flex:1}.del-btn{font-size:12px;color:#999;border:none;background:none;padding:5px}#edit-view,#pre-view{position:fixed;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column;background:#fff;z-index:99}.bar{padding:10px 16px;display:flex;align-items:center;border-bottom:1px solid #000;gap:6px;justify-content:flex-start}#fn{width:120px;border:none;outline:0;font-size:15px;font-weight:bold;flex-shrink:1}textarea{flex:1;width:100%;padding:20px;border:none;outline:0;font-size:16px;line-height:1.6;color:#333;white-space:pre-wrap;word-break:break-all;overflow-y:auto}iframe{flex:1;width:100%;border:none}.btn{border:1px solid #000;background:none;padding:6px 16px;font-size:12px;text-transform:uppercase;font-weight:bold;cursor:pointer;white-space:nowrap;margin-right:2px}.btn-black{background:#000;color:#fff}.fs-bar{padding:10px 20px;display:flex;align-items:center;font-size:11px;color:#999;border-bottom:1px solid #eee;justify-content:space-between}.empty{text-align:center;margin-top:100px;font-size:14px;color:#ccc;letter-spacing:2px}</style></head><body>
<header>
    <div id="hd-top"><h1>世纪简码</h1><button class="btn btn-black" onclick="edit('')">新建文件</button></div>
    <div id="hd-btns"><button class="btn btn-s" onclick="bakOut()">备份全部</button><button class="btn btn-s" onclick="$('bakIn').click()">导入备份</button><input type="file" id="bakIn" style="display:none" onchange="bakLoad(this)" accept=".json"></div>
</header>
<div id="list-view"></div>
<div id="edit-view">
    <div class="bar"><input id="fn" spellcheck="false" placeholder="文件名"><button class="btn" onclick="save()">保存</button><button class="btn" onclick="exp()">导出</button><button class="btn" onclick="back()">返回</button><button class="btn btn-black" onclick="run()">运行</button></div>
    <div class="fs-bar"><div><span>字体 </span><span onclick="setFs(-2)" style="cursor:pointer;color:#000;font-weight:bold;padding:0 5px">—</span><span id="fv" style="color:#000">16px</span><span onclick="setFs(2)" style="cursor:pointer;color:#000;font-weight:bold;padding:0 5px">＋</span></div><div><span onclick="undo()" style="cursor:pointer;color:#000;font-weight:bold;font-size:16px;padding:0 10px">←</span><span onclick="redo()" style="cursor:pointer;color:#000;font-weight:bold;font-size:16px;padding:0 10px">→</span></div></div>
    <textarea id="ed" spellcheck="false" oninput="record()"></textarea>
</div>
<div id="pre-view"><div class="bar"><span id="pre-title" style="flex:1;font-weight:bold;font-size:14px">预览</span><button class="btn" onclick="$('pre-view').style.display='none'">关闭预览</button></div><iframe id="ifr"></iframe></div>

<script>
let db=JSON.parse(localStorage.getItem('h_v6')||'{}'),
    hisDb=JSON.parse(localStorage.getItem('h_his_v6')||'{}'),
    fs=16, his=[], hIdx=-1, curOldName='';

const $=id=>document.getElementById(id), lv=$('list-view'), ev=$('edit-view');

function render(){
    lv.innerHTML=Object.keys(db).length?'':'<div class="empty">未找到文件</div>';
    Object.keys(db).sort().forEach(n=>{
        let d=document.createElement('div');
        d.className='item';
        d.innerHTML=`<div class="item-name" onclick="edit('${n}')">${n}</div><button class="del-btn" onclick="del('${n}')">删除</button>`;
        lv.appendChild(d)
    })
}

function edit(n){
    ev.style.display='flex';
    curOldName = n;
    let name = n || '未命名.HTML';
    $('fn').value = name;
    let c = n ? db[n] : '<!DOCTYPE html>\n<html>\n<body>\n<h1>你好世界</h1>\n</body>\n</html>';
    $('ed').value = c;
    
    // 初始化历史：只取该文件的历史，如果没有则创建
    let key = name.toUpperCase();
    his = hisDb[key] || [c];
    hIdx = his.length - 1;
    $('ed').focus();
}

function record(){
    const c=$('ed').value, n=$('fn').value;
    if(!n || c===his[hIdx]) return;
    
    // 限制 10 步，减少存储压力
    if(hIdx < his.length - 1) his = his.slice(0, hIdx + 1);
    his.push(c);
    if(his.length > 10) his.shift();
    hIdx = his.length - 1;

    // 存入历史库和草稿
    try {
        hisDb[n.toUpperCase()] = his;
        localStorage.setItem('h_his_v6', JSON.stringify(hisDb));
        localStorage.setItem('last_draft', JSON.stringify({n:n, c:c, old:curOldName}));
    } catch(e) {
        console.log("存储额度可能已满");
    }
}

function undo(){
    if(hIdx > 0){ hIdx--; $('ed').value = his[hIdx]; syncState(); }
}

function redo(){
    if(hIdx < his.length - 1){ hIdx++; $('ed').value = his[hIdx]; syncState(); }
}

function syncState(){
    const n = $('fn').value;
    if(!n) return;
    try {
        hisDb[n.toUpperCase()] = his;
        localStorage.setItem('h_his_v6', JSON.stringify(hisDb));
        localStorage.setItem('last_draft', JSON.stringify({n:n, c:$('ed').value, old:curOldName}));
    } catch(e) {}
}

function save(){
    let n=$('fn').value.toUpperCase(), c=$('ed').value;
    if(!n) return alert('请输入文件名');
    
    try {
        // 改名逻辑
        if(curOldName && curOldName.toUpperCase() !== n){
            let ok = curOldName.toUpperCase();
            if(hisDb[ok]) { hisDb[n] = hisDb[ok]; delete hisDb[ok]; }
            delete db[curOldName];
            curOldName = $('fn').value;
        }
        db[n] = c;
        localStorage.setItem('h_v6', JSON.stringify(db));
        localStorage.setItem('h_his_v6', JSON.stringify(hisDb));
        localStorage.removeItem('last_draft');
        render();
        return true;
    } catch(e) {
        alert("保存失败：存储空间已满，请删除一些旧文件或缩短代码长度。");
        return false;
    }
}

function back(){
    ev.style.display='none';
    localStorage.removeItem('last_draft');
    render();
}

function run(){
    let n=$('fn').value, c=$('ed').value;
    if(!n) return alert('请输入文件名');
    // 尝试保存，如果空间满了，至少要在预览里跑起来
    save();
    $('ifr').srcdoc = c;
    $('pre-view').style.display='flex';
    $('pre-title').innerText = '预览: ' + n;
}

function del(n){
    if(confirm('确认删除？')){
        delete db[n];
        delete hisDb[n.toUpperCase()];
        localStorage.setItem('h_v6', JSON.stringify(db));
        localStorage.setItem('h_his_v6', JSON.stringify(hisDb));
        render();
    }
}

function setFs(v){
    fs+=v; if(fs<10)fs=10;
    $('ed').style.fontSize=fs+'px';
    $('fv').innerText=fs+'px';
}

function exp(){
    if(save()){
        const n=$('fn').value.toUpperCase(), c=$('ed').value;
        const b=new Blob([c],{type:'text/html'}), u=URL.createObjectURL(b), a=document.createElement('a');
        a.href=u; a.download=n.endsWith('.HTML')?n:n+'.HTML'; a.click();
    }
}

function bakOut(){
    const b=new Blob([JSON.stringify(db)],{type:'application/json'}), u=URL.createObjectURL(b), a=document.createElement('a');
    a.href=u; a.download='世纪简码备份_'+new Date().getTime()+'.json'; a.click();
}

function bakLoad(i){
    const f=i.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=e=>{
        try{
            db=Object.assign(db, JSON.parse(e.target.result));
            localStorage.setItem('h_v6', JSON.stringify(db));
            render();
            alert('导入成功');
        }catch(err){alert('格式错误')}
    };
    r.readAsText(f);
}

window.onload=()=>{
    render();
    let d=JSON.parse(localStorage.getItem('last_draft'));
    if(d && confirm('发现上次未正常关闭的草稿，是否恢复？')){
        edit(d.old);
        $('fn').value = d.n;
        $('ed').value = d.c;
        record();
    }
};
</script>
</body></html>
