<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>世纪简码</title><style>*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{margin:0;height:100vh;background:#fff;color:#000;overflow:hidden;font-family:system-ui,-apple-system,sans-serif}header{padding:15px 20px;display:flex;flex-direction:column;gap:10px;border-bottom:1px solid #000}#hd-top{display:flex;justify-content:space-between;align-items:center}h1{margin:0;font-size:18px;font-weight:900;text-transform:uppercase}#hd-btns{display:flex;gap:8px}.btn-s{padding:5px 10px;font-size:11px}#list-view{flex:1;overflow-y:auto;padding:0 20px}.item{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid #eee}.item-name{font-size:16px;flex:1}.del-btn{font-size:12px;color:#999;border:none;background:none;padding:5px}.page{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:flex;flex-direction:column;transition:transform 0.2s ease-out;z-index:10}#pre-view{transform:translateX(100%);z-index:20}.show-pre #pre-view{transform:translateX(0)}.show-pre #edit-view{transform:translateX(-100%)}.bar{padding:10px 16px;display:flex;align-items:center;border-bottom:1px solid #000;gap:6px}#fn{width:120px;border:none;outline:0;font-size:15px;font-weight:700}#ed{flex:1;width:100%;padding:20px;outline:0;font-size:16px;line-height:1.6;white-space:pre-wrap;word-break:break-all;overflow-y:auto}.h-lite{background-color:#000!important;color:#fff!important;display:inline}.btn{border:1px solid #000;background:none;padding:6px 16px;font-size:12px;font-weight:700;cursor:pointer}.btn-black{background:#000;color:#fff}.fs-bar{padding:10px 20px;display:flex;align-items:center;font-size:11px;color:#999;border-bottom:1px solid #eee;justify-content:space-between}#search-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:85%;background:#fff;border:1.5px solid #000;border-radius:30px;padding:5px 15px;display:none;align-items:center;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,0.1)}#search-in{flex:1;border:none;outline:none;padding:10px;font-size:14px}#ifr{flex:1;width:100%;border:none;background:#fff}.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:10px 20px;border-radius:5px;z-index:1000;font-size:14px;animation:fadeOut 2s forwards;animation-delay:1s}@keyframes fadeOut{from{opacity:1}to{opacity:0}}</style></head><body><header id="main-hd"><div id="hd-top"><h1>世纪简码</h1><button class="btn btn-black" onclick="edit('')">新建文件</button></div><div id="hd-btns"><button class="btn btn-s" onclick="bakOut()">备份全部</button><button class="btn btn-s" onclick="$('bakIn').click()">导入备份</button><input type="file" id="bakIn" style="display:none" onchange="bakLoad(this)" accept=".json"></div></header><div id="list-view"></div><div id="edit-view" class="page"><div class="bar"><input id="fn" spellcheck="false" placeholder="文件名"><button class="btn" onclick="save()">保存</button><button class="btn" onclick="exp()">导出</button><button class="btn" onclick="back()">返回</button><button class="btn btn-black" onclick="run()">运行</button></div><div class="fs-bar"><div><span>字体 </span><span onclick="setFs(-2)" style="cursor:pointer;font-weight:700;padding:0 5px">—</span><span id="fv">16px</span><span onclick="setFs(2)" style="cursor:pointer;font-weight:700;padding:0 5px">＋</span></div><div style="display:flex;align-items:center"><svg onclick="toggleS()" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><span onclick="undo()" style="cursor:pointer;font-weight:700;font-size:16px;padding:0 10px">←</span><span onclick="redo()" style="cursor:pointer;font-weight:700;font-size:16px;padding:0 10px">→</span></div></div><div id="ed" contenteditable="true" spellcheck="false" oninput="handleInput()"></div><div id="search-bar"><input id="search-in" placeholder="搜代码..." oninput="doSearch()"><span onclick="toggleS()" style="font-weight:bold;padding:0 5px;cursor:pointer">✕</span></div></div><div id="pre-view" class="page"><div class="bar"><span id="pre-title" style="flex:1;font-weight:700;font-size:14px">预览</span><button class="btn" onclick="closePre()">关闭</button></div><iframe id="ifr"></iframe></div><script>let db_idb,fs=16,currentFileName='',rawText='',isSearching=false;const $=i=>document.getElementById(i),ed=$('ed'),ifr=$('ifr'),fileHistories=new Map,blobUrls=new Set;let currentHistory={his:[],hIdx:-1};const request=indexedDB.open("EditorDB",2);request.onupgradeneeded=e=>{let d=e.target.result;if(!d.objectStoreNames.contains("files"))d.createObjectStore("files",{keyPath:"id"});if(!d.objectStoreNames.contains("history"))d.createObjectStore("history",{keyPath:"id"});if(!d.objectStoreNames.contains("settings"))d.createObjectStore("settings",{keyPath:"id"})};request.onsuccess=e=>{db_idb=e.target.result;render()};request.onerror=e=>{console.error("数据库打开失败:",e);showToast("数据库初始化失败，请刷新页面")};function dbOperation(s,m,o){return new Promise((r,j)=>{const t=db_idb.transaction(s,m);t.onerror=e=>{console.error("数据库事务错误:",e);j(e.target.error)};t.oncomplete=()=>r();try{o(t)}catch(e){j(e)}})}function render(){dbOperation(["files"],"readonly",t=>{const s=t.objectStore("files"),r=s.getAll();r.onsuccess=e=>{const f=e.target.result;$('list-view').innerHTML='';f.sort((a,b)=>a.id.localeCompare(b.id)).forEach(n=>{let d=document.createElement('div');d.className='item';d.dataset.filename=n.id;d.innerHTML=`<div class="item-name">${escapeHTML(n.id)}</div><button class="del-btn">删除</button>`;d.querySelector('.item-name').addEventListener('click',()=>edit(n.id));d.querySelector('.del-btn').addEventListener('click',e=>{e.stopPropagation();del(n.id)});$('list-view').appendChild(d)})};r.onerror=e=>{console.error("读取文件列表失败:",e);showToast("读取文件列表失败")}}).catch(e=>{console.error("渲染失败:",e)})}function saveFullHistory(){if(!currentFileName)return;let h=[...currentHistory.his];if(h.length>20)h=h.slice(-20);dbOperation(["history"],"readwrite",t=>{t.objectStore("history").put({id:currentFileName,data:h,lastIndex:currentHistory.hIdx,timestamp:Date.now()})}).catch(e=>{console.error("保存历史失败:",e)})}function edit(n){isSearching=false;$('edit-view').style.display='flex';$('main-hd').style.display='none';if(currentFileName&&rawText){fileHistories.set(currentFileName,{his:[...currentHistory.his],hIdx:currentHistory.hIdx})}currentFileName=n;$('fn').value=n||'未命名.HTML';if(!n){ed.innerText='';rawText='';currentHistory={his:[''],hIdx:0};return}dbOperation(["files","history"],"readonly",t=>{const f=t.objectStore("files").get(n);f.onsuccess=e=>{if(e.target.result){rawText=e.target.result.content;ed.innerText=rawText}};const h=t.objectStore("history").get(n);h.onsuccess=e2=>{if(e2.target.result){currentHistory={his:e2.target.result.data||[rawText||''],hIdx:e2.target.result.lastIndex||0};if(currentHistory.hIdx>=currentHistory.his.length)currentHistory.hIdx=currentHistory.his.length-1}else{currentHistory={his:[rawText||''],hIdx:0}}if(currentHistory.his.length>20){currentHistory.his=currentHistory.his.slice(-20);currentHistory.hIdx=currentHistory.his.length-1}}}).catch(e=>{console.error("加载文件失败:",e);showToast("加载文件失败")});ed.focus()}function handleInput(){if(isSearching)return;const n=ed.innerText;if(n===rawText)return;rawText=n;if(currentHistory.hIdx<currentHistory.his.length-1)currentHistory.his=currentHistory.his.slice(0,currentHistory.hIdx+1);currentHistory.his.push(rawText);currentHistory.hIdx=currentHistory.his.length-1;if(currentHistory.his.length>20){currentHistory.his=currentHistory.his.slice(-20);currentHistory.hIdx=currentHistory.his.length-1}clearTimeout(window.historySaveTimeout);window.historySaveTimeout=setTimeout(()=>{if(currentFileName)saveFullHistory()},2000)}function undo(){if(currentHistory.hIdx>0){currentHistory.hIdx--;rawText=currentHistory.his[currentHistory.hIdx];ed.innerText=rawText;saveFullHistory()}}function redo(){if(currentHistory.hIdx<currentHistory.his.length-1){currentHistory.hIdx++;rawText=currentHistory.his[currentHistory.hIdx];ed.innerText=rawText;saveFullHistory()}}function save(){let n=$('fn').value.trim();if(!n){showToast('请输入文件名');return false}n=sanitizeFilename(n);$('fn').value=n;const c=ed.innerText,o=currentFileName;if(c!==rawText){currentHistory.his.push(c);currentHistory.hIdx=currentHistory.his.length-1;rawText=c}if(currentHistory.his.length>20){currentHistory.his=currentHistory.his.slice(-20);currentHistory.hIdx=currentHistory.his.length-1}return new Promise(r=>{dbOperation(["files","history"],"readwrite",t=>{if(o&&o!==n){t.objectStore("files").delete(o);const hr=t.objectStore("history").get(o);hr.onsuccess=e=>{if(e.target.result){t.objectStore("history").put({id:n,data:e.target.result.data,lastIndex:currentHistory.hIdx,timestamp:Date.now()});t.objectStore("history").delete(o)}}}t.objectStore("files").put({id:n,content:c});let h=[...currentHistory.his];if(h.length>20)h=h.slice(-20);t.objectStore("history").put({id:n,data:h,lastIndex:currentHistory.hIdx,timestamp:Date.now()})}).then(()=>{currentFileName=n;render();showToast('保存成功');r(true)}).catch(e=>{console.error("保存失败:",e);showToast('保存失败');r(false)})})}function back(){$('edit-view').style.display='none';$('main-hd').style.display='flex';$('search-bar').style.display='none';isSearching=false;restoreOriginalText();render()}function run(){save().then(s=>{if(s){document.body.classList.add('show-pre');ifr.srcdoc=ed.innerText;$('pre-title').innerText='预览: '+$('fn').value}})}function closePre(){document.body.classList.remove('show-pre');ifr.srcdoc=''}function del(n){if(confirm('确定删除文件 "'+n+'" ？')){dbOperation(["files","history"],"readwrite",t=>{t.objectStore("files").delete(n);t.objectStore("history").delete(n)}).then(()=>{fileHistories.delete(n);render();showToast('删除成功')}).catch(e=>{console.error("删除失败:",e);showToast('删除失败')})}}function setFs(v){fs+=v;if(fs<0)fs=0;if(fs>30)fs=30;ed.style.fontSize=fs+'px';$('fv').innerText=fs===0?'0px(隐藏)':fs+'px';dbOperation(["settings"],"readwrite",t=>{t.objectStore("settings").put({id:'fontSize',value:fs})})}let searchBackup=null;function toggleS(){const b=$('search-bar');if(b.style.display==='flex'){isSearching=false;restoreOriginalText();b.style.display='none';$('search-in').value=''}else{isSearching=true;b.style.display='flex';$('search-in').focus()}}function doSearch(){const q=$('search-in').value;if(!q){restoreOriginalText();return}if(!searchBackup)searchBackup=ed.innerHTML;const t=ed.innerText,r=new RegExp(escapeRegExp(q),'gi');let re='',li=0,m;while((m=r.exec(t))!==null){re+=escapeHTML(t.substring(li,m.index));re+='<span class="h-lite">'+escapeHTML(m[0])+'</span>';li=m.index+m[0].length}re+=escapeHTML(t.substring(li));ed.innerHTML=re;const fm=ed.querySelector('.h-lite');if(fm)fm.scrollIntoView({block:'center',behavior:'smooth'})}function restoreOriginalText(){if(searchBackup){ed.innerHTML=searchBackup;searchBackup=null}}function exp(){save().then(s=>{if(s){const n=$('fn').value,c=ed.innerText,b=new Blob([c],{type:'text/html'}),u=URL.createObjectURL(b);blobUrls.add(u);const a=document.createElement('a');a.href=u;a.download=n.endsWith('.HTML')||n.endsWith('.html')?n:n+'.HTML';document.body.appendChild(a);a.click();document.body.removeChild(a);setTimeout(()=>{URL.revokeObjectURL(u);blobUrls.delete(u)},10000)}})}function bakOut(){db_idb.transaction("files").objectStore("files").getAll().onsuccess=e=>{const b=new Blob([JSON.stringify(e.target.result)],{type:'application/json'}),u=URL.createObjectURL(b);blobUrls.add(u);const a=document.createElement('a');a.href=u;a.download='备份.json';a.click();setTimeout(()=>{URL.revokeObjectURL(u);blobUrls.delete(u)},10000);showToast('备份已开始下载')}}function bakLoad(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result),t=db_idb.transaction("files","readwrite");if(Array.isArray(d))d.forEach(i=>t.objectStore("files").put(i));else if(d.data&&Array.isArray(d.data.files))d.data.files.forEach(i=>t.objectStore("files").put(i));else{showToast('备份文件格式错误');return}t.oncomplete=()=>{render();showToast('导入成功')};t.onerror=()=>showToast('导入失败')}catch(e){console.error("备份解析失败:",e);showToast('备份文件格式错误')}};r.readAsText(f);i.value=''}function escapeHTML(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}function sanitizeFilename(n){n=n.replace(/[/\\?%*:|"<>]/g,'-');if(!n.includes('.'))n+='.HTML';if(n.length>100)n=n.substring(0,100);return n}function showToast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>{if(t.parentNode)document.body.removeChild(t)},3000)}window.addEventListener('beforeunload',()=>{if(currentFileName&&rawText){fileHistories.set(currentFileName,{his:[...currentHistory.his],hIdx:currentHistory.hIdx})}blobUrls.forEach(u=>URL.revokeObjectURL(u));blobUrls.clear()});window.addEventListener('load',()=>{dbOperation(["settings"],"readonly",t=>{const r=t.objectStore("settings").get('fontSize');r.onsuccess=e=>{if(e.target.result){fs=e.target.result.value;ed.style.fontSize=fs+'px';$('fv').innerText=fs===0?'0px(隐藏)':fs+'px'}}})});document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();save()}if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();undo()}if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();redo()}if(e.key==='Escape'){if(document.body.classList.contains('show-pre'))closePre();else if(isSearching)toggleS()}if((e.ctrlKey||e.metaKey)&&e.key==='f'){e.preventDefault();if(!$('search-bar').style.display||$('search-bar').style.display==='none')toggleS()}});</script></body></html>